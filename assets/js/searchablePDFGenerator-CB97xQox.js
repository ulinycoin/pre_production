import{P as b,S as F,r as v}from"./vendor-pdf-lib-CZHCEpXA.js";import{g as R,G as C}from"./vendor-pdfjs-BlOy0ZkI.js";import{o as O}from"./index-ByNlfbxM.js";import{O as u}from"./OCRPDF-C6Hk44yh.js";import"./vendor-react-CTjRfaZN.js";import"./vendor-word-CeUssL8V.js";import"./vendor-ocr-CTFn7PEu.js";import"./FileUpload-vqoJmZZ0.js";import"./ToolLayout-CEHQ6Lwh.js";import"./select-bI2aXbro.js";import"./index-NZhszMUr.js";import"./ProgressBar-CKe5kCn5.js";import"./DownloadGate-DVCOsD5O.js";import"./download-BBtiLdGt.js";import"./eye-D7o574wz.js";import"./copy-C86R9Vj5.js";import"./refresh-cw-B5_LaX6y.js";C.workerSrc=O;function x(r){const h=[];return new DOMParser().parseFromString(r,"text/html").querySelectorAll(".ocrx_word").forEach(t=>{const a=t.getAttribute("title"),c=t.textContent?.trim()||"";if(!a||!c)return;const i=a.match(/bbox (\d+) (\d+) (\d+) (\d+)/),e=a.match(/x_wconf (\d+)/);if(i){const[,s,g,w,d]=i.map(Number),p=e?Number(e[1]):0;h.push({text:c,bbox:{x0:s,y0:g,x1:w,y1:d},confidence:p})}}),h}async function S(r,h,o=2){const n=await r.arrayBuffer(),t=await(await R({data:n}).promise).getPage(h),a=t.getViewport({scale:o}),c=document.createElement("canvas"),i=c.getContext("2d");return c.height=a.height,c.width=a.width,await t.render({canvasContext:i,viewport:a}).promise,{canvas:c,width:a.width,height:a.height}}function B(r){return r.toDataURL("image/jpeg",.95)}async function y(r,h,o,n){const{width:m,height:t}=r.getSize(),a=await r.doc.embedFont(F.Helvetica),c=m/o,i=t/n;h.forEach(e=>{const s=e.bbox.x0*c,g=t-e.bbox.y1*i,d=(e.bbox.y1-e.bbox.y0)*i*.85;try{r.drawText(e.text,{x:s,y:g,size:d,font:a,color:v(0,0,0),opacity:0})}catch(p){console.warn(`Failed to draw word "${e.text}" at (${s}, ${g}):`,p)}})}async function q(r,h,o,n){n?.(0,"Initializing OCR engine...");const m=await u.getWorker(h),t=await b.create(),a=[];for(let i=0;i<o.length;i++){const e=o[i],s=i/o.length*50;n?.(s,`OCR processing page ${e}...`);const{canvas:g,width:w,height:d}=await S(r,e,2),{data:p}=await m.recognize(g,{},{hocr:!0}),f=p.hocr?x(p.hocr):[];a.push({pageNumber:e,words:f,pageWidth:w,pageHeight:d,imageData:B(g)})}for(let i=0;i<a.length;i++){const e=a[i],s=50+i/a.length*40;n?.(s,`Creating searchable page ${e.pageNumber}...`);const g=await fetch(e.imageData).then(p=>p.arrayBuffer()),w=await t.embedJpg(g),d=t.addPage([e.pageWidth,e.pageHeight]);d.drawImage(w,{x:0,y:0,width:e.pageWidth,height:e.pageHeight}),await y(d,e.words,e.pageWidth,e.pageHeight)}n?.(90,"Finalizing PDF...");const c=await t.save();return n?.(100,"Searchable PDF created!"),new Blob([new Uint8Array(c)],{type:"application/pdf"})}async function T(r,h,o){o?.(0,"Initializing OCR engine...");const n=await u.getWorker(h),m=URL.createObjectURL(r),t=new Image;await new Promise((l,D)=>{t.onload=l,t.onerror=D,t.src=m}),o?.(20,"Performing OCR...");const a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").drawImage(t,0,0);const{data:i}=await n.recognize(a,{},{hocr:!0});o?.(60,"Creating searchable PDF...");const e=i.hocr?x(i.hocr):[],s=await b.create(),g=s.addPage([t.width,t.height]),w=a.toDataURL("image/jpeg",.95),d=await fetch(w).then(l=>l.arrayBuffer()),p=await s.embedJpg(d);g.drawImage(p,{x:0,y:0,width:t.width,height:t.height}),o?.(80,"Adding text layer..."),await y(g,e,t.width,t.height),o?.(90,"Finalizing PDF..."),URL.revokeObjectURL(m);const f=await s.save();return o?.(100,"Searchable PDF created!"),new Blob([new Uint8Array(f)],{type:"application/pdf"})}export{q as createSearchablePDF,T as createSearchablePDFFromImage};
