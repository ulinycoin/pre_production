import{u as Ye,J as We,b as Oe,r,j as t,K as Ve,a as d,L as b,k,p as be,t as He}from"./index-ByNlfbxM.js";import{T as Je}from"./ToolLayout-CEHQ6Lwh.js";import{P as _e,f as Ge,r as Ke}from"./vendor-pdf-lib-CZHCEpXA.js";import{g as ve}from"./vendor-pdfjs-BlOy0ZkI.js";import{T as Ze,a as qe,b as Z}from"./tabs-DSPryEzR.js";import{D as Qe}from"./DownloadGate-DVCOsD5O.js";import{R as et}from"./refresh-cw-B5_LaX6y.js";import"./vendor-react-CTjRfaZN.js";import"./vendor-word-CeUssL8V.js";import"./vendor-ocr-CTFn7PEu.js";import"./FileUpload-vqoJmZZ0.js";import"./download-BBtiLdGt.js";const tt=`
  @font-face {
    font-family: 'Roboto';
    src: url('/fonts/Roboto-Regular.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }
  @font-face {
    font-family: 'Roboto';
    src: url('/fonts/Roboto-Bold.ttf') format('truetype');
    font-weight: bold;
    font-style: normal;
    font-display: swap;
  }
  @font-face {
    font-family: 'Roboto';
    src: url('/fonts/Roboto-Italic.ttf') format('truetype');
    font-weight: normal;
    font-style: italic;
    font-display: swap;
  }
  @font-face {
    font-family: 'Roboto';
    src: url('/fonts/Roboto-BoldItalic.ttf') format('truetype');
    font-weight: bold;
    font-style: italic;
    font-display: swap;
  }
`,gt=()=>{const{t:o}=Ye(),{status:q}=We(),Q=q==="pro"||q==="lifetime",{sharedFile:P,setSharedFile:ee,clearSharedFile:U}=Oe(),[c,I]=r.useState(null),[z,te]=r.useState(!1),[h,L]=r.useState(null),[v,ne]=r.useState(null),[se,ae]=r.useState(!1),[p,B]=r.useState(null),[oe,ie]=r.useState(!1),[re,le]=r.useState(!1),[ce,de]=r.useState({x:0,y:0}),[x,$]=r.useState(null),[C,F]=r.useState([]),[w,ue]=r.useState(1),[X,Se]=r.useState(1),[M,Y]=r.useState(1),[D,je]=r.useState({width:595.28,height:841.89}),S=r.useRef(null),W=r.useRef(null),[he,Ne]=r.useState(null),[ze,Ce]=r.useState(1),[s,j]=r.useState({type:"draw",width:200,height:80,text:"",textSize:12,color:"#000000",includeName:!1,nameText:"",nameSize:14});r.useEffect(()=>()=>{v&&URL.revokeObjectURL(v)},[v]),r.useEffect(()=>{(async()=>{try{const n=await fetch("/fonts/Roboto-Regular.ttf");if(!n.ok)throw new Error(`Font fetch failed: ${n.status}`);const a=await n.arrayBuffer();Ne(a)}catch(n){console.error("Failed to load font:",n)}})()},[]),r.useEffect(()=>{const e=()=>{if(W.current&&D.width>0){const n=W.current.getBoundingClientRect().width/M;Ce(n/D.width)}};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[D.width,M,v]),r.useEffect(()=>{if(P&&!c){const e=new File([P.blob],P.name,{type:"application/pdf"});fe([e]),U()}},[P,c,U]),r.useEffect(()=>{if(h?.blob&&!z&&!se){const e=c?.name.replace(/\.pdf$/i,"_signed.pdf")||"signed.pdf";ee(h.blob,e,"sign-pdf"),ae(!0)}},[h,z,se,c?.name,ee]),r.useEffect(()=>{x&&F(e=>e.map(n=>n.id===x?{...n,width:s.width,height:s.height,text:s.text,textSize:s.textSize,color:s.color,includeName:s.includeName,nameText:s.nameText,nameSize:s.nameSize,image:p||n.image}:n))},[s,p,x]),r.useEffect(()=>{s.type==="draw"&&S.current&&E()},[s.type,c]);const E=()=>{const e=S.current;if(!e)return;const n=e.getContext("2d");n&&(n.clearRect(0,0,e.width,e.height),n.strokeStyle=s.color,n.lineWidth=2,n.lineCap="round",n.lineJoin="round")},fe=async e=>{const n=e[0];if(!n)return;const a={id:`${Date.now()}`,file:n,name:n.name,size:n.size,status:"pending"};I(a),L(null),ae(!1),F([]),ue(1);try{const i=await n.arrayBuffer(),f=await ve({data:i}).promise;Se(f.numPages),await ge(f,1),I({...a,status:"completed"})}catch(i){console.error("Failed to load PDF info:",i),I({...a,status:"error",error:"Failed to read PDF"})}},ge=async(e,n)=>{try{const a=await e.getPage(n),i=a.getViewport({scale:1.5}),f=a.getViewport({scale:1});je({width:f.width,height:f.height});const u=document.createElement("canvas"),l=u.getContext("2d");u.height=i.height,u.width=i.width,await a.render({canvasContext:l,viewport:i}).promise,ne(u.toDataURL())}catch(a){console.error("Preview error:",a)}},me=async e=>{if(e<1||e>X||!c)return;ue(e);const n=await c.file.arrayBuffer(),a=await ve({data:n}).promise;await ge(a,e)},O=()=>{if(!p&&s.type!=="text"||s.type==="text"&&!s.text)return;const e={id:`${Date.now()}`,type:s.type,page:w,x:50,y:50,width:s.width,height:s.height,image:p||void 0,text:s.text,textSize:s.textSize,color:s.color,includeName:s.includeName,nameText:s.nameText,nameSize:s.nameSize};F(n=>[...n,e]),$(e.id)},Fe=e=>{F(n=>n.filter(a=>a.id!==e)),x===e&&$(null)},De=e=>{const n=S.current;if(!n)return;const a=n.getBoundingClientRect(),i=n.getContext("2d");i&&(ie(!0),i.beginPath(),i.moveTo(e.clientX-a.left,e.clientY-a.top))},Te=e=>{if(!oe)return;const n=S.current;if(!n)return;const a=n.getBoundingClientRect(),i=n.getContext("2d");i&&(i.strokeStyle=s.color,i.lineTo(e.clientX-a.left,e.clientY-a.top),i.stroke())},pe=()=>{if(!oe)return;ie(!1);const e=S.current;e&&B(e.toDataURL("image/png"))},Re=()=>{E(),B(null)},ke=e=>{const n=e.target.files?.[0];if(!n)return;const a=new FileReader;a.onload=i=>B(i.target?.result),a.readAsDataURL(n)},Pe=async()=>{if(!(!c||C.length===0)){te(!0);try{const e=await c.file.arrayBuffer(),n=await _e.load(e);n.registerFontkit(Ge);let a;he&&(a=await n.embedFont(he));const i=n.getPages();for(const l of C){const T=l.page-1;if(T<0||T>=i.length)continue;const N=i[T],{width:H,height:y}=N.getSize(),J=l.x/100*H-l.width/2,_=(1-l.y/100)*y-l.height/2,G=l.color||"#000000",Le=parseInt(G.slice(1,3),16)/255,$e=parseInt(G.slice(3,5),16)/255,Xe=parseInt(G.slice(5,7),16)/255,ye=Ke(Le,$e,Xe);if(l.type==="text"){const R=l.text||"",g=l.textSize||12,A=a?a.widthOfTextAtSize(R,g):R.length*g*.5,K=g;N.drawText(R,{x:J-A/2+l.width/2,y:_-K/2+l.height/2,size:g,color:ye,font:a})}else if(l.image){const R=l.image.split(",")[1],g=atob(R),A=new Uint8Array(g.length);for(let m=0;m<g.length;m++)A[m]=g.charCodeAt(m);const K=await n.embedPng(A);if(N.drawImage(K,{x:J,y:_,width:l.width,height:l.height}),l.includeName&&l.nameText){const m=l.nameSize||14;N.drawText(l.nameText,{x:J+l.width/2-l.nameText.length*m*.25,y:_-(m+5),size:m,color:ye})}}}let f=await n.save();const u=new Blob([f],{type:"application/pdf"});L({blob:u,metadata:{originalSize:c.size,finalSize:u.size,pageCount:i.length,signaturesApplied:C.length}})}catch(e){console.error(e),He.error(o("sign.errors.signFailed")||"Failed to sign PDF")}finally{te(!1)}}},Ie=async e=>{if(!h?.blob)return;let n=h.blob;if(!Q&&e)try{const a=await h.blob.arrayBuffer(),i=await be.applyWatermark(new Uint8Array(a));n=new Blob([new Uint8Array(i)],{type:"application/pdf"})}catch(a){console.error("Failed to apply watermark:",a)}be.downloadFile(n,c?.name.replace(".pdf","_signed.pdf")||"signed.pdf")},Be=()=>{I(null),L(null),ne(null),B(null),U()},xe=(e,n)=>{e.preventDefault(),le(!0),$(n);const a="touches"in e?e.touches[0].clientX:e.clientX,i="touches"in e?e.touches[0].clientY:e.clientY;de({x:a,y:i})},we=e=>{if(!re||!x)return;e.preventDefault();const n="touches"in e?e.touches[0].clientX:e.clientX,a="touches"in e?e.touches[0].clientY:e.clientY,i=n-ce.x,f=a-ce.y,u=document.getElementById("signature-preview-container");if(!u)return;const l=u.getBoundingClientRect(),T=i/l.width*100,N=f/l.height*100;F(H=>H.map(y=>y.id===x?{...y,x:Math.max(0,Math.min(100,y.x+T)),y:Math.max(0,Math.min(100,y.y+N))}:y)),de({x:n,y:a})},V=()=>{le(!1)},Me=()=>t.jsx(t.Fragment,{children:C.filter(e=>e.page===w).map(e=>t.jsxs("div",{style:{position:"absolute",zIndex:10,width:e.type==="text"?"auto":`${e.width/D.width*100}%`,height:e.type==="text"?"auto":`${e.height/D.height*100}%`,border:x===e.id?"2px solid #3b82f6":"1px dashed #3b82f6",backgroundColor:"rgba(255, 255, 255, 0.4)",cursor:re?"grabbing":"grab",top:`${e.y}%`,left:`${e.x}%`,transform:"translate(-50%, -50%)",userSelect:"none",borderRadius:"4px",padding:"4px"},onMouseDown:n=>xe(n,e.id),onTouchStart:n=>xe(n,e.id),className:"group relative",children:[e.type==="text"?t.jsx("div",{style:{fontSize:`${(e.textSize||12)*ze}px`,fontFamily:"Roboto, sans-serif",whiteSpace:"nowrap",color:e.color,lineHeight:1},children:e.text}):t.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.image&&t.jsx("img",{src:e.image,alt:"sig",className:"w-full h-auto pointer-events-none"}),e.includeName&&e.nameText&&t.jsx("div",{style:{fontSize:`${(e.nameSize||14)*.8}px`,fontFamily:"sans-serif",color:e.color,borderTop:"1px solid #ccc",paddingTop:"2px",width:"100%",textAlign:"center"},children:e.nameText})]}),t.jsx("button",{onClick:n=>{n.stopPropagation(),Fe(e.id)},className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 transition-opacity",children:"Ã—"})]},e.id))}),Ee=()=>t.jsxs("div",{className:"space-y-6",children:[t.jsx(Ze,{value:s.type,onValueChange:e=>{j({...s,type:e}),e==="draw"&&setTimeout(E,50)},children:t.jsxs(qe,{className:"grid w-full grid-cols-3",children:[t.jsx(Z,{value:"draw",children:o("sign.modeDraw")}),t.jsx(Z,{value:"upload",children:o("sign.modeUpload")}),t.jsx(Z,{value:"text",children:o("sign.modeText")})]})}),t.jsxs("div",{className:"space-y-3",children:[t.jsx(b,{className:"text-sm font-semibold",children:o("sign.color")}),t.jsx("div",{className:"flex gap-3",children:["#000000","#0000FF","#FF0000"].map(e=>t.jsx("button",{onClick:()=>{j({...s,color:e}),s.type==="draw"&&setTimeout(E,10)},style:{backgroundColor:e},className:`w-8 h-8 rounded-full border-2 ${s.color===e?"border-blue-500 scale-110":"border-gray-200"}`},e))})]}),s.type==="draw"&&t.jsxs("div",{className:"space-y-2",children:[t.jsx(b,{children:o("sign.drawSignature")}),t.jsx("div",{className:"border rounded-md overflow-hidden bg-white shadow-inner h-32 relative",children:t.jsx("canvas",{ref:S,width:300,height:120,onMouseDown:De,onMouseMove:Te,onMouseUp:pe,onMouseLeave:pe,className:"w-full h-full cursor-crosshair touch-none"})}),t.jsx(d,{variant:"ghost",size:"sm",onClick:Re,className:"text-xs w-full text-red-500 hover:text-red-600",children:o("sign.clearSignature")}),t.jsx(d,{onClick:O,className:"w-full mt-2 bg-blue-600 hover:bg-blue-700 h-9 text-xs",children:o("sign.apply")})]}),s.type==="upload"&&t.jsxs("div",{className:"space-y-4",children:[t.jsx(b,{children:o("sign.uploadImage")}),t.jsx(k,{type:"file",accept:"image/*",onChange:ke}),p&&t.jsx("div",{className:"border rounded p-2 bg-white",children:t.jsx("img",{src:p,className:"max-h-20 mx-auto",alt:"preview"})}),t.jsx(d,{onClick:O,disabled:!p,className:"w-full mt-2 bg-blue-600 hover:bg-blue-700 h-9 text-xs",children:o("sign.apply")})]}),s.type==="text"&&t.jsxs("div",{className:"space-y-3",children:[t.jsx(b,{children:o("sign.signatureText")}),t.jsx(k,{value:s.text,onChange:e=>j({...s,text:e.target.value}),placeholder:o("sign.placeholderName")}),t.jsxs(b,{children:[o("sign.textSize"),": ",s.textSize,"pt"]}),t.jsx(k,{type:"range",min:8,max:72,value:s.textSize,onChange:e=>j({...s,textSize:parseInt(e.target.value)})}),t.jsx(d,{onClick:O,disabled:!s.text,className:"w-full mt-2 bg-blue-600 hover:bg-blue-700 h-9 text-xs",children:o("sign.apply")})]}),t.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[t.jsx("div",{className:"flex justify-between items-center text-xs",children:t.jsxs(b,{children:[o("sign.width"),": ",s.width,"px"]})}),t.jsx(k,{type:"range",min:50,max:600,value:s.width,onChange:e=>j({...s,width:parseInt(e.target.value)})}),t.jsx("div",{className:"flex justify-between items-center text-xs",children:t.jsxs(b,{children:[o("sign.height"),": ",s.height,"px"]})}),t.jsx(k,{type:"range",min:20,max:400,value:s.height,onChange:e=>j({...s,height:parseInt(e.target.value)})})]})]}),Ae=()=>c?h?t.jsxs("div",{className:"text-center space-y-6",children:[t.jsx("div",{className:"w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto text-green-600",children:t.jsx(Ve,{className:"w-10 h-10"})}),t.jsx("h2",{className:"text-2xl font-bold",children:o("sign.successTitle")}),t.jsxs("div",{className:"flex justify-center gap-4",children:[t.jsx(Qe,{toolId:"sign-pdf",onDownload:Ie,showWatermarkLabel:!Q}),t.jsxs(d,{onClick:Be,variant:"outline",className:"h-11 rounded-xl px-8 border-2 font-bold",children:[t.jsx(et,{className:"mr-2 h-4 w-4"}),o("common.convertAnother")]})]})]}):t.jsxs("div",{className:"flex flex-col h-full bg-gray-50 dark:bg-gray-900/50 rounded-2xl overflow-hidden relative border border-gray-200 dark:border-gray-800 shadow-inner min-h-[600px]",children:[t.jsxs("div",{className:"bg-white dark:bg-gray-900 border-b p-2 flex items-center justify-between sticky top-0 z-20",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(d,{variant:"ghost",size:"sm",onClick:()=>me(w-1),disabled:w<=1,children:o("sign.prevPage")}),t.jsxs("span",{className:"text-sm font-medium min-w-[60px] text-center",children:[w," / ",X]}),t.jsx(d,{variant:"ghost",size:"sm",onClick:()=>me(w+1),disabled:w>=X,children:o("sign.nextPage")})]}),t.jsxs("div",{className:"flex items-center border rounded-md px-1 bg-gray-50 dark:bg-gray-800",children:[t.jsx(d,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>Y(e=>Math.max(.5,e-.1)),children:"-"}),t.jsxs("span",{className:"text-xs font-mono min-w-[40px] text-center",children:[Math.round(M*100),"%"]}),t.jsx(d,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>Y(e=>Math.min(3,e+.1)),children:"+"}),t.jsx(d,{variant:"ghost",size:"sm",className:"h-8 px-2 text-[10px]",onClick:()=>Y(1),children:o("common.reset")})]})]}),t.jsx("div",{className:"flex-1 flex items-center justify-center p-6 relative overflow-auto",onMouseMove:we,onTouchMove:we,onMouseUp:V,onTouchEnd:V,onMouseLeave:V,children:v?t.jsxs("div",{id:"signature-preview-container",ref:W,style:{transform:`scale(${M})`,transformOrigin:"center center",transition:"transform 0.1s ease-out"},className:"relative shadow-2xl bg-white leading-[0] w-fit mx-auto",children:[t.jsx("img",{src:v,alt:"PDF Preview",className:"max-h-[550px] w-auto object-contain pointer-events-none select-none"}),Me()]}):t.jsx("p",{className:"text-gray-500",children:o("sign.generatingPreview")})})]}):null,Ue=()=>t.jsx(d,{onClick:Pe,disabled:z||C.length===0,className:"w-full py-6 text-lg font-bold bg-green-600 hover:bg-green-700 text-white",children:o(z?"common.processing":"sign.finishAndSave")});return t.jsxs(Je,{title:o("tools.sign-pdf.name"),description:o("tools.sign-pdf.description"),hasFiles:!!c,onUpload:fe,isProcessing:z,maxFiles:1,uploadTitle:o("common.selectFile"),uploadDescription:o("upload.singleFileAllowed"),acceptedTypes:".pdf",settings:h?null:Ee(),actions:h?null:Ue(),sidebarWidth:"w-80",children:[t.jsx("style",{children:tt}),Ae()]})};export{gt as SignPDF};
